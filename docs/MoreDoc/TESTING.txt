ATLAS â€” TESTING & TDD RULES

1) TDD loop
1) Write a failing test
2) Implement minimal code to pass
3) Refactor safely
4) Repeat

2) Test pyramid
A) Unit tests (fast, many)
- Domain logic + service layer
- No DB
- Use fakes/stubs for repositories

B) Integration tests (fewer)
- API endpoints + Postgres
- Validate auth + RBAC + persistence

C) Optional end-to-end tests (very few)
- Bring up docker-compose and hit real HTTP endpoints

3) Minimum tests per endpoint (quality bar)
For each protected endpoint:
- 401 Unauthorized (no token)
- 403 Forbidden (wrong role)
- Happy path (valid role)
- 422 Validation error (bad payload) where applicable

4) Kafka/consumer testing rules
- Consumers must be idempotent:
  - same event twice must not duplicate side effects
- Include a test for dedup by event_id
- Include a test for retry/backoff decision logic (unit test acceptable)

5) Suggested folder structure (Python)
- tests/unit/
- tests/integration/
- tests/fixtures/

6) Running tests
- pytest -q
- Coverage:
  pytest --cov

7) Definition of done for a feature
- Tests written first (when possible)
- All tests passing
- New endpoints documented in API_CALLS.txt (or API.md)
- RBAC rules covered by tests
